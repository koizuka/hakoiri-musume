name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '22'

permissions:
  contents: write
  pull-requests: write
  pages: write
  id-token: write

jobs:
  # Detect which files have changed to determine if we need to run CI
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      app: ${{ steps.filter.outputs.app }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          base: main
          filters: |
            app:
              - 'src/**'
              - 'public/**'
              - 'package*.json'
              - 'tsconfig*.json'
              - 'vite.config.ts'
              - 'vitest.config.ts'
              - 'postcss.config.js'
              - 'tailwind.config.js'
              - 'eslint.config.js'
              - 'index.html'
              - 'components.json'
              - '.github/workflows/ci.yml'

  test:
    name: Test and Build
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.app == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run type check
      run: npm run typecheck

    - name: Run lint
      run: npm run lint

    - name: Run tests
      run: npm test

    - name: Build
      run: npm run build

    - name: Upload build artifacts
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: dist
        path: dist/

  # Deploy PR preview (only on PRs with Node 20.x)
  pr-preview:
    name: Deploy PR Preview
    runs-on: ubuntu-latest
    needs: [changes, test]
    if: |
      github.event_name == 'pull_request' && 
      needs.changes.outputs.app == 'true'
    
    # Use shared concurrency group for all deployments
    concurrency:
      group: "github-pages-deployment"
      cancel-in-progress: false

    steps:
      - name: Checkout PR
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build with PR-specific base path
        run: |
          # Create a temporary vite config for PR preview
          cat > vite.config.pr.ts << 'EOF'
          import { defineConfig } from 'vite'
          import react from '@vitejs/plugin-react'
          import path from 'path'

          export default defineConfig({
            plugins: [react()],
            base: '/hakoiri-musume/pr/${{ github.event.pull_request.number }}/',
            resolve: {
              alias: {
                '@': path.resolve(__dirname, './src'),
              },
            },
          })
          EOF

          # Build with the PR-specific config
          npx vite build --config vite.config.pr.ts

      - name: Deploy PR Preview
        uses: koizuka/pr-preview-action@e7366d355cc0c6a1b7d96965f1d3c82a82287297 # v1.0.0
        with:
          action: deploy
          source-dir: dist
          base-url: https://koizuka.github.io/hakoiri-musume
          token: ${{ secrets.GITHUB_TOKEN }}

  # Summary job that provides a single status check for branch protection
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [changes, test]
    if: always()

    steps:
      - name: Check CI Results
        run: |
          echo "Checking CI results..."
          echo "App changes: ${{ needs.changes.outputs.app }}"

          # Check if any tests were supposed to run
          if [[ "${{ needs.changes.outputs.app }}" == "true" ]]; then
            echo "Tests were executed. Checking results..."
            
            # Check if any job failed
            if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
              echo "❌ CI failed: One or more tests failed"
              exit 1
            fi
            
            # Check if any job was cancelled
            if [[ "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
              echo "⚠️ CI cancelled: One or more jobs were cancelled"
              exit 1
            fi
            
            echo "✅ All tests passed!"
          else
            echo "✅ No code changes detected - skipping tests"
          fi

          echo "CI completed successfully!"